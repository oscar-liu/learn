# MySQL锁

锁是计算机协调多个进程或线程并发访问某一资源的机制（避免争抢）。

在数据库中，除传统的计算资源（如CPU，RAM，I/O等）的竞争以外，数据也是一种供许多用户共享的资源，如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。



## 锁机制

为解决数据库的并发控制问题，如果在同一时刻，客户端对于同一个表做更新或者查询操 作，为保证数据的一致性，需要对并发操作进行控制，因此产生了锁。锁也是MySQL的事务隔离提供了保证。

### 锁的类型

#### 共享锁（S）读锁

代号是S，是Share的缩写，共享锁的锁粒度是行或者元组（多个行）。一个事务获取了共享锁之后，可以对锁定范围内的数据进行读操 作。

针对同一份数据，多个读操 作可以同时进行而不会相互影响。

#### 排他锁（X）写锁

代号是X，是eXclusive的缩写，排他锁的粒度与共享锁相同，也是行或者元组。一个事务获取了排他锁之后，可以对锁定范围内的数据执行写操作。

当前操作没有完成之前，它会阻断其他写锁和读锁。

#### 意向锁

意向锁是一种表锁，锁定的粒度是整张表，分为意向共享锁（IS）和意向排他锁（IX）两类。

意向共享锁表示一个事务有意对数据上共享锁或者排他锁。“有意”表示事务想执行操作但还没有真正执行。锁和锁之间的关系，要么是相容的，要么是互斥的。

相容：操作同样一组数据时，如果事务T1获取锁A，另一个事务T2还可以获取锁B；

互斥：操作同样一组数据时，如果事务T1获取锁A，另一个事务T2在T1释放锁A之间无法获取锁B。



为了尽可能提高数据库的并发量，需要每次锁定的数据范围越小越好，越小的锁其消耗的系统资源越多，系统性能下降。为了在高并发响应和系统性能两方面进行平衡，就有了锁粒度的概念。

### 锁粒度

锁的粒度主要分为表锁和行锁。

#### 表锁

表锁管理锁的开销最小，同时允许的并发量也是最小的锁机制。操作时，会锁住整个表。

MyISAM存储引擎使用该锁机制。当要写入数据时，把整个表记录锁住，此时其它读，写动作一律需要等待。alter tabl执行时也是使用的表锁。

#### 行锁

行锁可以支持最大的并发。InnoDB存储引擎就是使用行锁机制。操作时会锁住当前操作行。

| 存储引擎 | 表级锁 | 行级锁 |
| -------- | ------ | ------ |
| MyISAM   | 支持   | 不支持 |
| InnoDB   | 支持   | 支持   |
| MEMORY   | 支持   | 不支持 |

